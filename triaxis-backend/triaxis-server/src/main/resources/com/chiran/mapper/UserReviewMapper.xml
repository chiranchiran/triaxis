<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chiran.mapper.UserReviewMapper">

    <!-- 通用ResultMap：映射ReviewSearchVO（包含UserBO） -->
    <resultMap id="ReviewSearchVOResultMap" type="com.chiran.vo.ReviewSearchVO">
        <id column="review_id" property="id"/>
        <result column="rate" property="rate"/>
        <result column="content" property="content"/>
        <result column="publish_time" property="publishTime"/>
        <result column="like_count" property="likeCount"/>
        <result column="is_liked" property="isLiked"/>
        <result column="reply_count" property="replyCount"/>
        <result column="parent_id" property="parentId"/>
        <result column="root_id" property="rootId"/>

        <!-- 嵌套映射评论用户信息（UserBO） -->
        <association property="user" javaType="com.chiran.bo.UserBO">
            <result column="user_id" property="userId"/>
            <result column="username" property="username"/>
            <result column="avatar" property="avatar"/>
            <result column="school" property="school"/>
            <result column="grade" property="grade"/>
            <result column="major" property="major"/>
        </association>
        <!-- 嵌套映射评论用户信息（UserBO） -->
        <association property="replyTo" javaType="com.chiran.bo.UserBO">
            <result column="reply_to_user_id" property="userId"/>
            <result column="reply_to_username" property="username"/>
        </association>
    </resultMap>


    <!-- 第一个接口：根据targetType和targetId查询主评论列表 -->
    <select id="getReviews" parameterType="com.chiran.dto.ReviewSearchDTO" resultMap="ReviewSearchVOResultMap">
        SELECT
        r.id AS review_id,
        r.rate,
        r.content,
        r.publish_time,
        r.like_count,
        r.reply_count,
        -- 判断当前用户是否点赞（user_likes表存在记录则为true）
        EXISTS(
        SELECT 1 FROM user_likes ul
        WHERE ul.target_id = r.id AND ul.target_type = 4
        AND ul.user_id = #{userId} AND ul.deleted = 0
        ) AS is_liked,
        -- 匿名处理：所有用户属性均为null（包括avatar、school等）
        CASE WHEN r.is_anonymous = 1 THEN NULL ELSE u.id END AS user_id,
        CASE WHEN r.is_anonymous = 1 THEN NULL ELSE u.username END AS username,
        CASE WHEN r.is_anonymous = 1 THEN NULL ELSE u.avatar END AS avatar,
        CASE WHEN r.is_anonymous = 1 THEN NULL ELSE u.school END AS school,
        CASE WHEN r.is_anonymous = 1 THEN NULL ELSE u.grade END AS grade,
        CASE WHEN r.is_anonymous = 1 THEN NULL ELSE u.major END AS major
        FROM
        user_reviews r
        -- 关联评论用户信息（users表）
        LEFT JOIN users u ON r.user_id = u.id AND u.deleted = 0 AND r.is_anonymous = 0
        WHERE
        r.deleted = 0 -- 只查未删除的评论
        AND r.status = 1 -- 只查审核通过的评论
        AND ISNULL(parent_id)
        AND r.target_type = #{targetType}
        AND r.target_id = #{targetId}

        ORDER BY
        <choose>
            <when test="orderBy == 1">r.publish_time DESC</when>
            <when test="orderBy == 2">r.like_count DESC</when>
            <when test="orderBy == 3">r.reply_count DESC</when>
            <when test="orderBy == 4">(r.reply_count * 0.5 + r.like_count * 0.5) DESC</when>
            <otherwise>r.publish_time DESC</otherwise>
        </choose>
    </select>


    <!-- 功能：查询某条评论的所有回复，包含用户信息和当前用户点赞状态 -->
    <select id="getReviewReplies" parameterType="com.chiran.dto.ReviewSearchDTO" resultMap="ReviewSearchVOResultMap">
        SELECT
        r.id AS review_id,
        r.rate,
        r.content,
        r.publish_time,
        r.like_count,
        r.reply_count,
        r.parent_id,
        r.root_id,
        -- 判断当前用户是否点赞
        EXISTS(
        SELECT 1 FROM user_likes ul
        WHERE ul.target_id = r.id AND ul.target_type = 4
        AND ul.user_id = #{userId} AND ul.deleted = 0
        ) AS is_liked,
        -- 匿名处理：隐藏userId和username
        -- 回复用户信息（匿名时所有属性为null）
        CASE WHEN r.is_anonymous = 1 THEN NULL ELSE u.id END AS user_id,
        CASE WHEN r.is_anonymous = 1 THEN NULL ELSE u.username END AS username,
        CASE WHEN r.is_anonymous = 1 THEN NULL ELSE u.avatar END AS avatar,
        CASE WHEN r.is_anonymous = 1 THEN NULL ELSE u.school END AS school,
        CASE WHEN r.is_anonymous = 1 THEN NULL ELSE u.grade END AS grade,
        CASE WHEN r.is_anonymous = 1 THEN NULL ELSE u.major END AS major,
        -- 若被回复的评论是匿名的，或parent_id=root_id（直接回复主评论），则为null
        CASE
        WHEN r.parent_id != r.root_id AND r_parent.is_anonymous = 0
        THEN r_parent.user_id
        ELSE NULL
        END AS reply_to_user_id,
        CASE
        WHEN r.parent_id != r.root_id AND r_parent.is_anonymous = 0
        THEN u_parent.username
        ELSE NULL
        END AS reply_to_username
        FROM
        user_reviews r
        -- 关联回复用户表（非匿名才关联）
        LEFT JOIN users u
        ON r.user_id = u.id
        AND u.deleted = 0
        AND r.is_anonymous = 0
        -- 关联parent_id对应的评论（获取被回复的评论信息）
        LEFT JOIN user_reviews r_parent
        ON r.parent_id = r_parent.id
        AND r_parent.deleted = 0
        AND r_parent.status = 1  <!-- 被回复的评论需审核通过 -->
        -- 关联被回复评论的用户表（获取replyTo的username）
        LEFT JOIN users u_parent
        ON r_parent.user_id = u_parent.id
        AND u_parent.deleted = 0
        WHERE
        r.deleted = 0
        AND r.status = 1 -- 审核通过
        AND r.root_id = #{rootId}
        ORDER BY r.publish_time ASC
    </select>



    <resultMap id="ResourceVOMap" type="com.chiran.vo.UserMessageVO">
        <!-- 基础字段映射 -->
        <result property="id" column="id"/>
        <result property="type" column="type"/> <!-- 对应 ul.target_type -->
        <result property="sendTime" column="publish_time"/>
        <result property="isRead" column="is_read"/>
        <result property="review" column="review"/>

        <!-- 消息目标：type1-3 对应资源表（有title），type4 对应评论表（有content） -->
        <association property="messageTarget" javaType="com.chiran.bo.MessageTargetBo">
            <id property="targetId" column="msg_target_id"/>  <!-- 动态赋值的目标ID -->
            <result property="title" column="msg_title"/>      <!-- type1-3有值，type4 null -->
            <result property="content" column="msg_content"/>  <!-- type4有值，type1-3 null -->
        </association>

        <!-- 评论关联目标：仅 type4 有值 -->
        <association property="reviewTarget" javaType="com.chiran.bo.ReviewTargetBo">
            <id property="reviewTargetId" column="review_target_id"/>
            <result property="reviewTitle" column="review_title"/>
            <result property="reviewType" column="review_type"/> <!-- 对应 ur.target_type -->
        </association>

        <!-- 发送者信息 -->
        <association property="sender" javaType="com.chiran.bo.UserBO">
            <result property="userId" column="user_id"/>
            <result property="username" column="username"/>
            <result property="avatar" column="avatar"/>
            <result column="school" property="school"/>
            <result column="grade" property="grade"/>
            <result column="major" property="major"/>
        </association>
    </resultMap>

    <select id="selectResources" resultMap="ResourceVOMap">
        SELECT
        ul.id,
        ul.is_read,
        ul.target_type AS type,
        ul.user_id,
        ul.publish_time,
        ul.content AS review,
        u.username,
        u.avatar,
        u.school,
        u.grade,
        u.major,

        <!-- 1. 动态赋值 messageTarget：按 type 区分来源 -->
        -- msg_target_id：type1-3 取对应资源表ID，type4 取评论表ID
        CASE
        WHEN ul.target_type = 1 THEN MAX(r.id)
        WHEN ul.target_type = 2 THEN MAX(c.id)
        WHEN ul.target_type = 3 THEN MAX(p.id)
        WHEN ul.target_type = 4 THEN MAX(ur.id)
        END AS msg_target_id,

        -- msg_title：type1-3 取资源表title，type4 为null
        CASE
        WHEN ul.target_type = 1 THEN MAX(r.title)
        WHEN ul.target_type = 2 THEN MAX(c.title)
        WHEN ul.target_type = 3 THEN MAX(p.title)
        ELSE NULL
        END AS msg_title,

        -- msg_content：type4 取评论表content，type1-3 为null
        CASE
        WHEN ul.target_type = 4 THEN ur.content
        ELSE NULL
        END AS msg_content,

        <!-- 2. 动态赋值 reviewTarget：仅 type4 有效 -->
        -- review_target_id：按 ur.target_type 关联对应表ID
        CASE
        WHEN ul.target_type = 4 THEN
        CASE
        WHEN ur.target_type = 1 THEN MAX(r2.id)
        WHEN ur.target_type = 2 THEN MAX(c2.id)
        WHEN ur.target_type = 3 THEN MAX(p2.id)
        END
        ELSE NULL
        END AS review_target_id,

        -- review_title：按 ur.target_type 关联对应表title
        CASE
        WHEN ul.target_type = 4 THEN
        CASE
        WHEN ur.target_type = 1 THEN MAX(r2.title)
        WHEN ur.target_type = 2 THEN MAX(c2.title)
        WHEN ur.target_type = 3 THEN MAX(p2.title)
        END
        ELSE NULL
        END AS review_title,

        -- review_type：仅 type4 取 ur.target_type
        CASE WHEN ul.target_type = 4 THEN ur.target_type ELSE NULL END AS review_type

        FROM user_reviews ul
        LEFT JOIN users u
        ON ul.user_id = u.id AND u.deleted = 0

        -- ========== type1-3 关联对应资源表（条件匹配） ==========
        LEFT JOIN resources r
        ON ul.target_type = 1 AND ul.target_id = r.id AND r.deleted = 0
        LEFT JOIN courses c
        ON ul.target_type = 2 AND ul.target_id = c.id AND c.deleted = 0
        LEFT JOIN posts p
        ON ul.target_type = 3 AND ul.target_id = p.id AND p.deleted = 0

        -- ========== type4 关联评论表 + 评论对应的目标表 ==========
        -- 关联 user_reviews（评论表）
        LEFT JOIN user_reviews ur
        ON ul.target_type = 4 AND ul.target_id = ur.id AND ur.deleted = 0
        -- 评论目标：resources（ur.target_type=1）
        LEFT JOIN resources r2
        ON ul.target_type = 4 AND ur.target_type = 1 AND ur.target_id = r2.id AND r2.deleted = 0
        -- 评论目标：courses（ur.target_type=2）
        LEFT JOIN courses c2
        ON ul.target_type = 4 AND ur.target_type = 2 AND ur.target_id = c2.id AND c2.deleted = 0
        -- 评论目标：posts（ur.target_type=3）
        LEFT JOIN posts p2
        ON ul.target_type = 4 AND ur.target_type = 3 AND ur.target_id = p2.id AND p2.deleted = 0

        WHERE ul.deleted = 0
        <if test="id != null">
            AND (
            -- type1-3：按资源表的 user_id 过滤
            (ul.target_type = 1 AND r.user_id = #{id}) OR
            (ul.target_type = 2 AND c.user_id = #{id}) OR
            (ul.target_type = 3 AND p.user_id = #{id}) OR
            -- type4：按评论表的 user_id 过滤
            (ul.target_type = 4 AND ur.user_id = #{id})
            )
        </if>

        GROUP BY ul.id, ul.publish_time, type, user_id, username, avatar, school, grade, major, ur.content, ur.target_type
        ORDER BY ul.publish_time DESC
    </select>
</mapper>
