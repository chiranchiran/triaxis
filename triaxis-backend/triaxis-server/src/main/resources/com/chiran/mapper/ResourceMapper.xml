<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chiran.mapper.ResourceMapper">
    <select id="searchResources" resultType="com.chiran.vo.ResourceSearchVO">
        SELECT
        r.id,
        r.title,
        r.description,
        r.size,
        r.extension,
        r.user_id,
        r.price,
        r.download_count,
        r.collect_count,
        r.like_count,
        r.publish_time,
        r.update_time,
        -- 是否点赞：true=已点赞，false=未点赞
        CASE
        WHEN #{dto.userId} IS NULL THEN false
        WHEN ul.id IS NOT NULL THEN true
        ELSE false
        END AS isLiked,
        -- 是否收藏：true=已收藏，false=未收藏
        CASE
        WHEN #{dto.userId} IS NULL THEN false
        WHEN uf.id IS NOT NULL THEN true
        ELSE false
        END AS isCollected,
        CASE
        WHEN #{dto.userId} IS NULL THEN false
        WHEN up.id IS NOT NULL THEN true
        ELSE false
        END AS isPurchased
        FROM resources r
        LEFT JOIN resource_software rs ON r.id = rs.resource_id AND rs.deleted = 0
        LEFT JOIN resourse_category rc ON r.id = rc.resource_id AND rc.deleted = 0
        LEFT JOIN user_likes ul ON r.id = ul.target_id and ul.target_type=1 AND ul.user_id = #{dto.userId} AND ul.deleted = 0
        LEFT JOIN user_collections uf ON r.id = uf.target_id and uf.target_type=1 AND uf.user_id = #{dto.userId} AND uf.deleted = 0
        LEFT JOIN user_purchases up ON r.id = up.target_id and up.target_type=1 AND up.user_id = #{dto.userId} AND up.deleted = 0
        WHERE r.deleted = 0
        AND r.status = 3  <!-- 只查询已发布的资源 -->

        <!-- 单个条件查询 -->
        <if test="dto.rightId != null">
            AND r.right_id = #{dto.rightId}
        </if>
        <if test="dto.subjectId != null">
            AND r.subject_id = #{dto.subjectId}
        </if>

        <!-- 多类型查询 - toolId -->
        <if test="dto.toolIds != null and dto.toolIds.size() > 0">
            AND r.id IN (
            SELECT DISTINCT resource_id
            FROM resource_software
            WHERE software_id IN
            <foreach collection="dto.toolIds" item="tool" open="(" close=")" separator=",">
                #{tool}
            </foreach>
            )
        </if>

        <!-- 多类型查询 - categoryId -->
        <if test="dto.categoryIds != null and dto.categoryIds.size() > 0">
            AND r.id IN (
            SELECT DISTINCT resource_id
            FROM resource_category
            WHERE category_id IN
            <foreach collection="dto.categoryIds" item="category" open="(" close=")" separator=",">
                #{category}
            </foreach>
            )
        </if>

        <!-- 模糊搜索 -->
        <if test="dto.search != null and dto.search != ''">
            AND (
            r.title LIKE CONCAT('%', #{dto.search}, '%')
            OR r.description LIKE CONCAT('%', #{dto.search}, '%')
            OR r.details LIKE CONCAT('%', #{dto.search}, '%')
            )
        </if>

        GROUP BY r.id

        <!-- 排序 -->
        <choose>
            <when test="dto.orderBy == 0">
                ORDER BY r.create_time DESC
            </when>
            <when test="dto.orderBy == 1">
                ORDER BY r.collect_count DESC
            </when>
            <when test="dto.orderBy == 2">
                ORDER BY r.download_count DESC
            </when>
            <when test="dto.orderBy == 3">
                ORDER BY r.like_count DESC
            </when>
            <when test="dto.orderBy == 4">
                <!-- 综合排序：可以结合多个因素，这里简单示例 -->
                ORDER BY (r.download_count * 0.3 + r.collect_count * 0.2 + r.like_count * 0.5) DESC
            </when>
            <otherwise>
                ORDER BY r.create_time DESC
            </otherwise>
        </choose>
    </select>
</mapper>
