<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chiran.mapper.ResourceMapper">

    <resultMap id="ResourceSearchVOMap" type="com.chiran.vo.ResourceSearchVO">
        <!-- 映射资源详情 -->
        <association property="detail" javaType="com.chiran.bo.ResourceSearchBO">
            <id property="id" column="id"/>
            <result property="title" column="title"/>
            <result property="right" column="right"/>
            <result property="description" column="description"/>
            <result property="size" column="size"/>
            <result property="extension" column="extension"/>
            <result property="coverImage" column="cover_image"/>
            <result property="price" column="price"/>
            <result property="downloadCount" column="download_count"/>
            <result property="collectCount" column="collect_count"/>
            <result property="likeCount" column="like_count"/>
            <result property="publishTime" column="publish_time"/>
            <result property="updateTime" column="update_time"/>
        </association>

        <!-- 映射上传者信息 -->
        <association property="uploader" javaType="com.chiran.bo.UserBO">
            <result property="userId" column="user_id"/>
            <result property="username" column="username"/>
            <result property="avatar" column="avatar"/>
        </association>

        <!-- 映射用户行为状态 -->
        <association property="userActions" javaType="com.chiran.bo.UserActionsBO">
            <result property="isLiked" column="isLiked"/>
            <result property="isCollected" column="isCollected"/>
            <result property="isPurchased" column="isPurchased"/>
        </association>
    </resultMap>

    <select id="searchResources" resultMap="ResourceSearchVOMap">
        SELECT
        r.id,
        r.title,
        r.`right`,
        r.description,
        r.size,
        r.extension,
        r.cover_image,
        r.user_id,
        r.price,
        r.download_count,
        r.collect_count,
        r.like_count,
        r.publish_time,
        r.update_time,
        u.username,
        u.avatar,
        -- 是否点赞：true=已点赞，false=未点赞
        EXISTS(
        SELECT 1 FROM user_likes ul
        WHERE ul.target_id = r.id AND ul.target_type = 1
        AND ul.user_id = #{dto.userId} AND ul.deleted = 0
        ) AS isLiked,
        -- 是否收藏：true=已收藏，false=未收藏
        EXISTS(
        SELECT 1 FROM user_collections uf
        WHERE uf.target_id = r.id AND uf.target_type = 1
        AND uf.user_id = #{dto.userId} AND uf.deleted = 0
        ) AS isCollected,
        EXISTS(
        SELECT 1 FROM user_purchases up
        WHERE up.target_id = r.id AND up.target_type = 1
        AND up.user_id = #{dto.userId} AND up.deleted = 0
        ) AS isPurchased
        FROM resources r
        LEFT JOIN users u ON r.user_id = u.id AND u.deleted = 0
        WHERE r.deleted = 0
        AND r.status = 3   <!-- 只查询已发布的资源 -->

        <if test="dto.right != null">
            AND r.`right` = #{dto.right}
        </if>
        <if test="dto.subjectId != null">
            AND r.subject_id = #{dto.subjectId}
        </if>

        <!-- 使用 EXISTS 替代 IN 查询 -->
        <if test="dto.toolIds != null and dto.toolIds.size() > 0">
            AND EXISTS(
            SELECT 1 FROM resource_tool rs
            WHERE rs.resource_id = r.id AND rs.deleted = 0
            AND rs.tool_id IN
            <foreach collection="dto.toolIds" item="tool" open="(" close=")" separator=",">
                #{tool}
            </foreach>
            )
        </if>

        <choose>
            <!-- 1. 二级分类有值：按原逻辑查二级分类关联 -->
            <when test="dto.categoriesSecondary != null and dto.categoriesSecondary.size() > 0">
                AND EXISTS(
                SELECT 1 FROM resource_category rc
                WHERE rc.resource_id = r.id
                AND rc.deleted = 0
                AND rc.category_id IN
                <foreach collection="dto.categoriesSecondary" item="category" open="(" close=")" separator=",">
                    #{category}
                </foreach>
                )
            </when>

            <!-- 2. 二级分类为空，但一级分类有值：查二级分类的parent_id是否匹配一级分类 -->
            <when test="(dto.categoriesSecondary == null or dto.categoriesSecondary.size() == 0)
                and dto.categoriesFirst != null and dto.categoriesFirst.size() > 0">
                AND EXISTS(
                SELECT 1 FROM resource_category rc
                -- 关联分类表，获取二级分类的parent_id（即一级分类ID）
                INNER JOIN resource_categories rcate ON rc.category_id = rcate.id
                WHERE rc.resource_id = r.id
                AND rc.deleted = 0
                AND rcate.deleted = 0
                -- 筛选parent_id在一级分类列表中
                AND rcate.parent_id IN
                <foreach collection="dto.categoriesFirst" item="category" open="(" close=")" separator=",">
                    #{category}
                </foreach>
                )
            </when>

            <!-- 3. 两者都为空：不添加任何条件 -->
            <otherwise/>
        </choose>

        <if test="dto.search != null and dto.search != ''">
            AND (
            r.title LIKE CONCAT('%', #{dto.search}, '%')
            OR r.description LIKE CONCAT('%', #{dto.search}, '%')
            OR r.details LIKE CONCAT('%', #{dto.search}, '%')
            )
        </if>
        GROUP BY

        r.id, r.title, r.`right`, r.description, r.size, r.extension,
        r.cover_image, r.user_id, r.price, r.download_count, r.collect_count,
        r.like_count, r.publish_time, r.update_time, u.username, u.avatar

        <!-- 排序 -->
        <choose>
            <when test="dto.orderBy == 1">
                ORDER BY r.publish_time DESC
            </when>
            <when test="dto.orderBy == 2">
                ORDER BY r.collect_count DESC
            </when>
            <when test="dto.orderBy == 3">
                ORDER BY r.download_count DESC
            </when>
            <when test="dto.orderBy == 4">
                ORDER BY r.like_count DESC
            </when>
            <when test="dto.orderBy == 5">
                ORDER BY (r.download_count * 0.3 + r.collect_count * 0.2 + r.like_count * 0.5) DESC
            </when>
            <otherwise>
                ORDER BY r.publish_time DESC
            </otherwise>
        </choose>
    </select>
</mapper>